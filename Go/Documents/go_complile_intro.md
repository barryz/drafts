# Go编译器简介

> 翻译自: [Introduction to the Go compiler](https://github.com/golang/go/blob/master/src/cmd/compile/README.md)


`cmd/compile` 包含了构成go编译器主要的包。编译器可能被逻辑的分成四个阶段，我们将简要地介绍下这些包的代码。

当提及到编译器时，会经常听到前端和后端这些术语。粗略地说，这些翻译将会是我们接下来列出的两个阶段
。第三个术语“中端”通常指的是第二阶段所发生的大部分工作。

需要注意的是，`go/*` 相关的包， 例如 `go/parser` 、`go/types`， 和编译器是没有关系的。因为编译器最开始是由C语言编写的。 开发 `go/*` 用来编写和go代码一起工作的工具， 例如 `gofmt`， `govet`。


## 1. 解析

- `cmd/compile/internal/syntax` (词法分析器， 解析器，语法树)。

在编译的第一阶段， 源代码将被标记化（词法分析），解析（静态分析），并且为每个源代码文件构建一个语法树。

每个语法树都是源代码文件的精确表示，节点对应于源代码的各种元素， 例如表达式，声明， 语句等。语法树还包括用于错误报告和创建调试信息的位置信息。

## 2. 类型检查和AST（抽象语法树）转换

 - `cmd/compile/internal/gc` (创建AST编译器， 类型检查， AST转换)

 gc包中包含一个AST定义，它是用C编写的。它的所有代码都是由它编写的，所以gc包做的第一件事就是将语法包的语法树转换成编译器的AST表示。这个额外的步骤可能会在未来进行重构。

 然后对AST进行类型检查。 第一步就是名称解析和类型推断，以确定哪个对象属于哪个标识符，以及每个表达式有哪些类型。类型检查包含一些额外的检查， 例如 `"declare not used"` 以及确定函数是否终止。

 AST上也进行了某种转换，一些节点根据类型信息进行细化，比如字符串添加从算术加法节点类型中分离出来。其他一些例子是无效代码清除，函数调用内联， 逃逸分析等。


## 3. 通用SSA

 - `cmd/compile/internal/gc` (转换成SSA)
 - `cmd/compile/internal/ssa` （SSA通行准则）

 在这个阶段，AST被转化成单一静态分析(SSA)的形式， 一个具有特定属性的较低级别的中间表示，这使得更加容易实现优化并最终从中生成机器代码。

 在此转换过程中，函数的内联函数将被应用。这些特殊函数是编译器被教导用于个别情况下代替大量优化的代码。

 在AST到SSA转换过程中，某些节点也会降低到更为简单的组件，以便编译器的其余部门可以与它们一起工作。举例来说， 内置的`copy`被替换成内存移动，`range loop`被重写进`for loop` 中。由于一些历史原因， 其中一些目前发生在转成成SSA之前，但长期计划是将它们全部移到这里。

 然后， 应用一系列与机器无关的pass和规则，这些不涉及任何单一的计算机体系架构， 因此可以在所有的 `GOARCH` 变体上运行。

 这些通用的通行例子包括无效代码清除，删除不需要的零值检查，以及删除未使用的分支等。通用重写规则主要涉及表达式，例如常量值替换成某些表达式， 并优化乘法和浮点数运算等。



## 4. 生成机器代码

 - `cmd/compile/internal/ssa` (降低SSA和指定平台通行规则验证)
 - `cmd/internal/obj` (机器代码生成)

 编译器机器相关的阶段以”较低“阶段开始，它将通用的值重写成特定的机器变体。例如， 在amd64平台上内存操作如果存在可能性，所有很多加载存储的操作就可以被组合起来。

 需要注意的是， 低级别的pass运行所有指定机器的重写规则，因此它现在也做了很多的优化。

 一旦SSA被”降低”且更加具体到了目标架构，就将会运行最终的代码优化passes。这里会包括另一个清除无效代码的pass，移动values值到经常使用的位置，删除永远不会读取到的局部变量和寄存器分配。

 在此步骤中完成的其他重要工作包括栈帧布局，将堆栈偏移量分配给局部变量，以及指针活性分析，该指针计算每个GC安全点上哪些堆栈内存处于活动状态。

 在SSA生成阶段结束的时候，Go函数被转换成一系列的obj.Proj指令，这些指令被传递给汇编器（`cmd/internal/obj`），它将它们转换为机器代码并写出到最终的目标文件。目标文件还包括反射数据，导出数据和调试信息。

## 5. 延伸阅读

想要深入了解SSA包的工作原理，包括其通行证和规则，请前往：

`cmd/compile/internal/ssa/README.md`.
